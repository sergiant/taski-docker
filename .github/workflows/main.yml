name: Taski CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  DOCKER_USERNAME: sergiant

jobs:
  # ðŸ” Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð‘Ð­ÐšÐ•ÐÐ”Ð
  backend-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13.10
        env:
          POSTGRES_USER: django_user
          POSTGRES_PASSWORD: django_password
          POSTGRES_DB: django_db
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.12

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8==6.0.0
        pip install -r ./backend/requirements.txt

    - name: Run flake8
      run: |
        python -m flake8 backend/ --ignore=W503,F811,E501 --exclude="*/migrations/*,*/venv/*,*/env/*" --max-line-length=119
        # Flake8 Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð½Ð°Ð¹Ð´ÐµÑ‚ setup.cfg Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸

    - name: Run Django tests
      env:
        POSTGRES_USER: django_user
        POSTGRES_PASSWORD: django_password
        POSTGRES_DB: django_db
        DB_HOST: 127.0.0.1
        DB_PORT: 5432
      run: |
        cd backend
        python manage.py test

  # ðŸ” Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð¤Ð ÐžÐÐ¢Ð•ÐÐ”Ð
  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run tests
      run: |
        cd frontend
        npm run test

  # ðŸ³ Ð¡Ð‘ÐžÐ ÐšÐ Ð˜ ÐŸÐ£Ð¨ ÐžÐ‘Ð ÐÐ—ÐžÐ’
  build-and-push:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push backend
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: ${{ env.DOCKER_USERNAME }}/taski_backend:latest
        
    - name: Build and push frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ${{ env.DOCKER_USERNAME }}/taski_frontend:latest
        
    - name: Build and push gateway
      uses: docker/build-push-action@v4
      with:
        context: ./gateway
        push: true
        tags: ${{ env.DOCKER_USERNAME }}/taski_gateway:latest

  # ðŸš€ Ð”Ð•ÐŸÐ›ÐžÐ™ ÐÐ Ð¡Ð•Ð Ð’Ð•Ð 
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      # ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ð° Ñ€Ð°Ð½Ð½ÐµÑ€
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ docker-compose.production.yml Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      - name: Copy docker-compose to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "docker-compose.production.yml"
          target: "taski"
      
      # ðŸ” Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½-Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸
      - name: Create .env file on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd taski
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
            cat > .env << 'EOF'
            # Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… PostgreSQL
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            DB_HOST=db
            DB_PORT=5432
            
            # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Django
            DEBUG=False
            SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            ALLOWED_HOSTS=51.250.16.90,localhost,127.0.0.1
            
            # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
            CSRF_TRUSTED_ORIGINS=https://51.250.16.90
            EOF
            echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"
      
      # ðŸ³ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
      - name: Update and restart containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd taski
            echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹..."
            
            # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ñ Docker Hub
            echo "ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹..."
            sudo docker compose -f docker-compose.production.yml pull
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            sudo docker compose -f docker-compose.production.yml down
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
            echo "â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            sudo docker compose -f docker-compose.production.yml up -d
            
            # Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ð¿ÑƒÑÑ‚ÑÑ‚ÑÑ
            echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
            sleep 15
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
            sudo docker compose -f docker-compose.production.yml ps
      
      # ðŸ—ƒï¸ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
      - name: Run database migrations
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd taski
            echo "ðŸ—ƒï¸ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
            sudo docker compose -f docker-compose.production.yml exec backend python manage.py migrate
            echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
      
      # ðŸ“¦ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Django
      - name: Collect static files
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd taski
            echo "ðŸ“¦ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹..."
            sudo docker compose -f docker-compose.production.yml exec backend python manage.py collectstatic --noinput
            echo "âœ… Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ð±Ñ€Ð°Ð½Ñ‹"
      
      # ðŸ“ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÐºÑƒ Ð² Ð¾Ð±Ñ‰Ð¸Ð¹ volume Ð´Ð»Ñ Nginx
      - name: Copy static files to shared volume
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd taski
            echo "ðŸ“ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÐºÑƒ Ð² volume..."
            sudo docker compose -f docker-compose.production.yml exec backend cp -r /app/collected_static/. /backend_static/static/
            echo "âœ… Ð¡Ñ‚Ð°Ñ‚Ð¸ÐºÐ° ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð² volume"
      
      # âœ… Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
      - name: Final check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd taski
            echo "ðŸ” Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°..."
            echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð²ÑÐµÑ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
            sudo docker compose -f docker-compose.production.yml ps
            
            echo "ðŸ³ Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹:"
            sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo "ðŸ’¾ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ volumes:"
            sudo docker volume ls
            
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
            echo "ðŸŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://51.250.16.90"

  # ðŸ“¨ Ð£Ð’Ð•Ð”ÐžÐœÐ›Ð•ÐÐ˜Ð• Ð’ TELEGRAM
  notify:
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Send Telegram notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ðŸš€ Taski ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½!
          Ð¡ÐµÑ€Ð²ÐµÑ€: 51.250.16.90
          Ð’Ñ€ÐµÐ¼Ñ: ${{ github.event.head_commit.timestamp }}
          ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.event.head_commit.message }}
